# 아키텍처 특성 범위

과거에는 아키텍처 특성을 전체 시스템 레벨에서 다루는 것이 일반적이었습니다.  
예를 들어 확장성은 전체 시스템의 확장성과 동일한 의미였습니다.  
하지만 마이크로서비스와 같은 현대적 아키텍처 스타일이 등장하면서 아키텍처 특성의 범위가 좁아졌습니다.  
소프트웨어 개발 생태계가 빠르게 진화하면서, 기존의 전제가 더 이상 유효하지 않게 되는 사례가 늘어났습니다.

아키텍처의 구조적 진화 가능성을 측정할 새로운 기술이 필요했습니다. 
앞서 살펴본 메트릭들은 저수준의 코드만 평가할 수 있어, 운영에 영향을 미치는 외부 의존성(예: 데이터베이스)을 고려하지 못했습니다.  
예를 들어 성능과 탄력성을 고려하여 코드베이스를 작성 해도, 아키텍처에 부적합한 데이터베이스를 사용하면 시스템의 성공이 어렵습니다.  

따라서 운영 아키텍처 특성을 지키기 위해서는 코드베이스 외부의 컴포넌트 의존성도 신중히 검토해야 합니다.  
이를 측정하기 위해 '아키텍처 퀀텀' 이라는 용어를 정의했습니다.  
아키텍처 퀀텀을 이해하기 위해서는 '커네이선스'라는 핵심 메트릭을 이해해야 합니다.

## 7.1 커플링과 커네이선스

구심/원심 커플링 같은 코드 레벨의 커플링 메트릭은 아키텍처 분석에 사용하기엔 너무 세분화되어 있습니다.  
이를 보강하기 위해 '커네이선스'라는 새로운 커플링 메트릭이 소개되었습니다.

#### 커네이선스

두 컴포넌트 중 하나가 변경되면 다른 쪽도 함께 변경되어야 정합성이 유지되면, 이들은 **커네이선스**를 가진다고 합니다.  
아키텍처 퀀텀을 정의하려면 컴포넌트 간의 연결 상태를 측정하는 게 필요한데, 이 때 커네이선스 개념을 사용할 수 있습니다.  
커네이선스는 정적 코드 분석으로 측정 가능한 **정적 커네이선스**와 런타임 동작에서 등장하는 **동적 커네이선스**로 나뉩니다.  
예를 들어, 두 마이크로서비스가 동일한 클래스를 공유하면 정적 커네이선스를 가진다고 볼 수 있습니다.  
동적 커네이선스는 동기 호출과 비동기 호출로 나뉘며, 동기 호출은 caller가 callee의 응답을 기다리는 방식이고, 비동기 호출은 fire-and-forget으로 응답 여부와 별개로 시스템이 작동하는 방식입니다.

## 7.2 아키텍처 퀀텀과 세분도

소프트웨어의 결합은 단순히 컴포넌트 레벨의 커플링으로 인해서만 발생하는 것이 아닙니다.  
많은 경우 비즈니스 개념은 여러 시스템 파트를 기능적으로 응집시킵니다.  
따라서 개발자는 문제될 수 있는 모든 커플링 지점을 살펴봐야 하는데, 이를 위해 '아키텍처 퀀텀' 개념이 도입되었습니다.

### 아키텍처 퀀텀
아키텍처 퀀텀은 `높은 기능 응집도(high functional cohesion)와 동기적 커네이선스(synchronous connascence)를 가진, 독립적으로 배포 가능(Independently deployable)한 아티팩트` 로 정의된다.

#### 독립적으로 배포 가능(Independently deployable)

아키텍처 퀀텀은 다른 파트와 독립적으로 작동하는 모든 필수 컴포넌트를 포함합니다.  
예를 들어, 데이터베이스가 필요한 애플리케이션은 데이터베이스가 퀀텀의 일부입니다.  
하나의 데이터베이스를 사용하는 일반적인 레거시 시스템은 퀀텀이 1개인 반면, 각 서비스가 별도의 데이터베이스를 사용는 마이크로서비스 아키텍처는 퀀텀이 여러 개입니다.

#### 높은 기능적 응집도(high functional cohesion)

응집도는 컴포넌트가 목적에 맞게 얼마나 잘 통합되어 있는지를 나타냅니다.  
예를 들어 Customer 컴포넌트는 고객 엔티티와 관련된 모든 요소를 포함해 응집도가 높은 반면, Utility 컴포넌트는 다양한 기능을 무작위로 섞어 응집도가 낮습니다.  
기능 응집도가 높다는 것은 아키텍처 퀀텀이 명확한 목적을 수행한다는 의미입니다.  
모놀리식 애플리케이션에서는 각 퀀텀의 기능적 구분이 덜 중요하지만, 마이크로서비스 아키텍처는 각 서비스가 특정 워크플로에 맞게 설계되기 때문에 응집도가 높아야 합니다.

#### 동기적 커네이선스(synchronous connascence)

동기적 커네이선스는 애플리케이션 콘텍스트 내부의 분산 서비스 간 동기 호출을 의미합니다.  
대표적으로 마이크로서비스 아키텍처에서 한 서비스가 다른 서비스를 동기 호출할 때, 두 서비스의 운영 아키텍처 특성은 비슷해야 합니다.  
예를 들어 확장성 차이가 크면 타임아웃 등으로 인해 신뢰성 문제가 발생할 수 있습니다.  
마이크로서비스 아키텍처에서 Auction 서비스가 경매 종료 후 Payment 서비스에 결제 정보를 동기적으로 전달한다고 해봅시다.  
Payment 서비스가 500밀리초마다 하나의 결제만 처리할 수 있다면, 많은 경매가 동시에 종료된 경우 첫 번째 요청만 정상 처리 되고 나머지는 타임아웃이 발생하개 됩니다.  
이를 해결하려면 비동기 통신 링크를 만들고. 메시지 큐를 버퍼로 사용해 비동기적 커네이선스를 적용해야 합니다.

### 부록: 도메인 주도 설계

에릭 에반스의 『도메인 주도 설계』는 현대 아키텍처 사고에 큰 영향을 미쳤습니다.  
DDD는 복잡한 문제 도메인을 체계적으로 분해하는 모델링 기법으로, 경계 콘텍스트라는 개념을 정의합니다.  
경계 콘텍스트 내부에서는 모든 것이 보이지만, 외부에서는 보이지 않습니다.  
이전에는 공통 엔티티를 정의하고 재사용해 커플링 문제가 발생했습니다.  
DDD는 각 도메인에 맞는 자체 클래스를 사용하고, 차이점은 통합 시점에서 조정하는 방식을 제안합니다.

###  7.2.1 사례 연구: GGG

아키텍처 퀀텀 개념은 아키텍처 특성의 범위를 시스템 레벨에서 퀀텀 레벨로 좁힙니다.  
이로 인해 중요한 운영 관심사를 조기에 발견하고, 하이브리드 아키텍처를 설계하여 대응할 수 있게 됩니다.  
다음 절에서는 아키텍처 카타를 통해 퀀텀 관점에서 아키텍처 특성을 분석하는 방법을 설명합니다.

 ####  ‘전국적인 확장’, ‘경매당 참여자는 수백 명, 어쩌면 수천 명까지 늘어날 수 있고 많은 동시 경매가 이루어질 것이다’, ‘경매는 가급적 실시간 처리가 가능해야 한다’

**확장성**과 **탄력성**을 필수적인 특성으로 꼽을 수 있습니다.  
확장성은 요구사항에 명시되지만, 탄력성은 암묵적으로 나타납니다.  
도메인 지식을 바탕으로 생각했을 때 경매 후반부에 트래픽이 폭주할 가능성이 크다는 것을 알 수 있고, 따라서 확장성이 필요함을 유추할 수 있습니다.  
또한 실시간으로 경매가 진행됨을 고려하여 **성능**을 핵심 아키텍처 특성으로 고려할 수 있습니다.

#### 입찰자는 낙찰 시 자동 결제할 신용카드를 등록한다’, ‘이 회사는 위조 혐의로 고발된 소송에서 이제 막 벗어 났다’

보안은 거의 모든 애플리케이션에 암묵적으로 존재하는 아키텍처 특성입니다.  
아키텍트는 보안 요건을 특별한 설계로 해결할지, 일반적인 설계로 충분할지 판단해야 합니다.  
예를 들어, 신용카드 번호를 충분히 암호화한 후 통신한다면 일반적인 설계를 사용해도 충분할 수 있습니다.   
다만 과거 보안 문제의 사례가 있으므로, 보안 관점에서 빠트린 것이 없도록 검토가 필요합니다.

#### ‘입찰자는 평판 자수로 추적되어야 한다’

뭔가를 '추적'해야 한다는 요구사항은 감사성, 로그성과 같은 아키텍처 특성을 내포합니다.  
이 때 구현을 하는데 도메인 지식이 필요한지를 판단하여, 추상적 아키텍처 특성인지를 파악할 수 있습니다.  
위 예시에서 '평판지수’는 도메인 지식에 속하기 때문에, 요구 사항이 도메인에 속함을 알 수 있습니다.  

####  '이 경매 회사는 공격적으로 규모가 상대적으로 작은 경쟁사를 인수 합병하여 사세를 키우고 있다'

이 요구사항은 애플리케이션 설계에 직접적인 영향을 미치지는 않지만, 다양한 방안을 고려할 때 중요한 결정 요인이 될 수 있습니다.  
예를 들어, 통신 프로토콜을 선택할 때 새로 합병된 회사와의 연동에 문제가 없으면 특화된 프로토콜을 사용할 수 있습니다. 상호운용성 같은 트레이드오프를 고려해야 할 수도 있습니다. 

#### ‘예산 제한은 따로 없다. 전략적으로 그렇게 결정됐다’

일반적으로 트레이드오프를 반영하기 위해 솔루션에 예산 제약을 가하는 아키텍처도 있지만, 이 예시에서는 그런 제약이 없어 더 정교하고 특화된 아키텍처를 선택할 수 있습니다.  
이것은 6번 요구사항에도 도움이 됩니다.

#### ‘입찰자는 라이브 동영상 스트림을 시청하면서 발생하는 모든 입찰을 볼 수 있어야 한다’, ‘온라인/라이브 입찰 모두 입찰이 일어난 순서대로 접수되어야 한다’

이 요구사항은 애플리케이션 구조에 영향을 미치며, 아키텍처 특성을 시스템 전체로 평가하는 것이 무의미함을 보여줍니다.  
위 예시에서는 아키텍처 전반에 걸친 균일한 가용성이 필요하지 않습니다.  
경매인이 접속할 수 없으면 모든 입찰이 불가능하기 때문에 경매인의 가용성이 더 중요한 문제입니다.  
또한 uptime, 데이터 무결성 등을 내포하는 신뢰성은 가용성과 연관됩니다.  
경매 사이트는 경합 조건을 제거하여 메시지 순서를 정확히 보장하는 등의 조치를 통해 신뢰성을 확보해야 합니다.

이 요구사항은 시스템 레벨보다 더 세분화된 아키텍처 범위가 필요함을 보여줍니다.  
아키텍처 퀀텀을 구분하고, 각 퀀텀 레벨로 아키텍처 특성의 범위를 세분화하여 지정할 수 있습니다.  
아키텍처 퀀텀마다 상이한 배포, 커플링, 데이터 저장 위치, 통신 스타일 등을 고려하여, 초기부터 하이브리드 아키텍처로 설계할 수 있습니다.  
위 예시에서도 각 파트마다 다른 특성을 설정할 수 있으며, 입찰 스트리밍, 온라인 입찰자, 경매인 등 각 파트마다 다른 아키텍처 특성을 정의할 수 있습니다.

- 입찰자 피드백: 입찰 스트림과 입찰 동영상 스트림을 포함
  - 가용성, 확장성, 성능

- 경매인: 라이브 경매인
  - 가용성, 신뢰성, 확장성, 탄력성, 성능, 보안

- 입찰자: 온라인 입찰자와 입찰
  - 신뢰성, 가용성, 확장성, 탄력성
